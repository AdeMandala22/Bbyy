<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday Sayangku!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Font - Press Start 2P (Pixel Font) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #4f00bc, #2a0052, #1a0033);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .console-body {
            background-color: #e0e0e0;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 0 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 380px;
            position: relative;
        }

        .console-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px; }
        .power-led { width: 10px; height: 10px; background-color: red; border-radius: 50%; box-shadow: 0 0 5px red; }
        .brand-name { font-size: 0.6em; color: #555; }

        .screen-area {
            background-color: #25392b;
            border: 4px solid #1a1a1a;
            border-radius: 8px;
            height: 240px; /* Adjusted height for tetris */
            margin-bottom: 20px;
            padding: 15px;
            color: #9effae;
            overflow-y: auto;
            position: relative;
            font-size: 0.7em;
            line-height: 1.5;
            background-image: repeating-linear-gradient( transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px );
        }
        .screen-area::-webkit-scrollbar { width: 8px; }
        .screen-area::-webkit-scrollbar-track { background: #25392b; }
        .screen-area::-webkit-scrollbar-thumb { background: #9effae; border-radius: 4px; }

        .controls-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-buttons-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }

        .main-button {
            padding: 10px 5px; border-radius: 8px; color: white; text-align: center;
            font-size: 0.7em; border: none;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2), inset 0 -2px 0 rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.1s ease;
        }
        .main-button:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }

        .btn-message { background-color: #3b82f6; } .btn-gallery { background-color: #ef4444; }
        .btn-music { background-color: #8b5cf6; } .btn-tetris { background-color: #22c55e; }

        .d-pad-container { display: flex; justify-content: center; align-items: center; }
        .d-pad { display: grid; grid-template-areas: ". up ." "left center right" ". down ."; width: 90px; height: 90px; }
        .d-pad button { background-color: #4a4a4a; border: 1px solid #333; color: white; display: flex; align-items: center; justify-content: center; }
        .d-pad button:active { background-color: #333; }
        .d-pad .up { grid-area: up; border-radius: 5px 5px 0 0; }
        .d-pad .down { grid-area: down; border-radius: 0 0 5px 5px; }
        .d-pad .left { grid-area: left; border-radius: 5px 0 0 5px; }
        .d-pad .right { grid-area: right; border-radius: 0 5px 5px 0; }
        .d-pad .center { grid-area: center; background-color: #3a3a3a; }

        .action-buttons-container { display: flex; flex-direction: column; justify-content: space-around; align-items: center; }
        .action-button {
            width: 45px; height: 45px; border-radius: 50%; background-color: #d9534f;
            color: white; font-size: 1em; border: 2px solid #a94442;
            box-shadow: 0 3px 0 #792421; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .action-button:active { transform: translateY(2px); box-shadow: 0 1px 0 #792421; }
        .action-button.b-button { margin-bottom: 10px;}

        .bottom-controls { display: flex; justify-content: space-around; align-items: center; margin-top: 15px; }
        .control-btn-sm { background-color: #6c757d; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.6em; border: none; box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .control-btn-sm:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        
        .screen-content { display: none; height: 100%; }
        .screen-content.active { display: block; }

        .nav-button {
            padding: 8px 10px; font-size: 0.8em; border-radius: 5px; color: white;
            border: none; margin-top:10px; cursor: pointer; display: block;
            width: 100%; text-align: center; box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .nav-button:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        .btn-next { background-color: #22c55e; } .btn-back { background-color: #ef4444; }
        .btn-skip { background-color: #6b7280; margin-top: 5px; }

        #galleryImage { max-width: 100%; max-height: 120px; border: 2px solid #9effae; margin: 10px auto; display: block; object-fit: contain; background-color: #1e2b22; }
        .music-player img { width: 60px; height: 60px; border: 1px solid #9effae; margin: 0 auto 5px auto; display:block; object-fit: cover; }
        .music-player .song-title { font-size: 0.8em; margin-bottom: 2px; text-align: center;}
        .music-player .song-artist { font-size: 0.7em; margin-bottom: 5px; text-align: center;}
        .music-player .progress-bar { width: 100%; height: 5px; background: #555; margin-bottom: 5px; border-radius: 2px;}
        .music-player .progress { width: 0%; height: 100%; background: #9effae; border-radius: 2px;}
        .music-player .controls { display: flex; justify-content: space-around; margin-bottom: 5px;}
        .music-player .controls button { background: none; border: none; color: #9effae; font-size: 1.2em; cursor: pointer;}
        .music-player .playlist { font-size: 0.6em; max-height: 50px; overflow-y: auto; border-top: 1px solid #555; padding-top: 5px;}
        .music-player .playlist div { padding: 2px 0; cursor: pointer; }
        .music-player .playlist div:hover { background-color: rgba(158,255,174,0.2); }

        #tetris-grid-container { position: relative; }
        #tetris-grid {
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(18, 1fr);    
            width: 100%; height: 180px; border: 1px solid #9effae; background-color: #1e2b22; margin-bottom: 5px;
        }
        .tetris-cell { border: 1px solid #25392b; }
        .tetris-cell.filledI { background-color: cyan; box-shadow: inset 0 0 2px #fff; } 
        .tetris-cell.filledL { background-color: orange; box-shadow: inset 0 0 2px #fff;}
        .tetris-cell.filledJ { background-color: blue; box-shadow: inset 0 0 2px #fff;} 
        .tetris-cell.filledT { background-color: purple; box-shadow: inset 0 0 2px #fff;}
        .tetris-cell.filledS { background-color: lime; box-shadow: inset 0 0 2px #fff;} 
        .tetris-cell.filledZ { background-color: red; box-shadow: inset 0 0 2px #fff;} 
        .tetris-cell.filledO { background-color: yellow; box-shadow: inset 0 0 2px #fff;}
        .tetris-controls { display: flex; justify-content: space-around; margin-top: 5px; }
        .tetris-controls button { background-color: #555; color: #9effae; border: 1px solid #9effae; padding: 3px 6px; font-size: 0.6em; border-radius: 3px; }
        .start-game-btn { background-color: #16a34a !important; color: white !important; width: 100%; margin-top: 5px;}
        #home-screen h1 { font-size: 0.9em; margin-bottom: 10px; text-align:center; }
        #home-screen p { font-size: 0.7em; text-align:center; }
        #tetris-game-over {
            position: absolute; inset: 0; 
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white; text-align:center;
            font-size: 1.5em; /* 24px */
        }
    </style>
</head>
<body>
    <audio id="main-audio-player" loop></audio>

    <div class="console-body">
        <div class="console-top-bar"><div class="power-led"></div><div class="brand-name">OhMyHades</div><div></div></div>
        <div id="screen" class="screen-area">
            <div id="home-screen" class="screen-content active"><h1>Happy Birthday Sayang!</h1><p>Pilih menu di bawah</p></div>
            <div id="message-screen" class="screen-content"><h2 class="text-center text-lg mb-2">Pesan Untukmu</h2><div id="message-content" class="mb-2 text-sm"></div><button id="nextMessageBtn" class="nav-button btn-next">Selanjutnya</button><button id="skipMessageBtn" class="nav-button btn-skip">Lewati Semua</button><button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button></div>
            <div id="gallery-screen" class="screen-content"><h2 class="text-center text-lg mb-1">My Bby Area üòé</h2><p class="text-xs text-center mb-1">ü§ç</p><div id="galleryMedia"></div><p id="galleryCounter" class="text-xs text-center my-1"></p><button id="nextImageBtn" class="nav-button btn-next">Selanjutnya</button><button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button></div>
            <div id="music-screen" class="screen-content music-player"><h2 class="text-center text-lg mb-1">Pemutar Musik</h2><img id="albumArt" src="https://placehold.co/60x60/25392b/9effae?text=Art" alt="Album Art"><div id="songTitle" class="song-title">Lagu Pilihan</div><div id="songArtist" class="song-artist">Artisnya</div><div class="progress-bar"><div id="musicProgress" class="progress"></div></div><div class="controls"><button id="prevSongBtn"><i class="fas fa-backward"></i></button><button id="playPauseBtn"><i class="fas fa-play"></i></button><button id="nextSongBtn"><i class="fas fa-forward"></i></button></div><div class="playlist" id="playlistContainer"></div><button onclick="showScreen('home-screen')" class="nav-button btn-back mt-2">Kembali</button></div>
            <div id="tetris-screen" class="screen-content"><div class="flex justify-between text-xs mb-1"><span>SKOR: <span id="tetrisScore">0</span></span><span>LEVEL: <span id="tetrisLevel">1</span></span></div><div class="flex justify-between text-xs mb-1"><span>GARIS: <span id="tetrisLines">0</span></span></div><div id="tetris-grid-container"><div id="tetris-grid"></div><div id="tetris-game-over"></div></div><div class="tetris-controls text-center"><button id="tetrisLeftBtn">&lt;</button><button id="tetrisRotateBtn">ROTASI</button><button id="tetrisRightBtn">&gt;</button></div><button id="tetrisStartBtn" class="nav-button start-game-btn">MULAI GAME</button><button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button></div>
        </div>

        <div class="menu-buttons-grid">
            <button onclick="showScreen('message-screen'); startMessages();" class="main-button btn-message">PESAN</button>
            <button onclick="showScreen('gallery-screen'); startGallery();" class="main-button btn-gallery">GALERI</button>
            <button onclick="showScreen('music-screen');" class="main-button btn-music">MUSIK</button>
            <button onclick="showScreen('tetris-screen'); initTetris();" class="main-button btn-tetris">TETRIS</button>
        </div>
        <div class="controls-area">
            <div class="d-pad-container"><div class="d-pad"><button class="up" id="dpadUp"><i class="fas fa-caret-up"></i></button><button class="left" id="dpadLeft"><i class="fas fa-caret-left"></i></button><button class="center"></button><button class="right" id="dpadRight"><i class="fas fa-caret-right"></i></button><button class="down" id="dpadDown"><i class="fas fa-caret-down"></i></button></div></div>
            <div class="action-buttons-container"><button class="action-button b-button" id="buttonB">B</button><button class="action-button a-button" id="buttonA">A</button></div>
        </div>
        <div class="bottom-controls"><button class="control-btn-sm">SELECT</button><button class="control-btn-sm">START</button><div class="text-xs text-gray-600">...</div></div>
    </div>

<script>
    // --- Variabel Global ---
    let audioSystemsInitialized = false;

    // --- Konfigurasi Playlist Muzik ---
    const musicPlaylist = [
        { src: "/vitamin_paul.mp3", title: "vitamin", artist: "paul", artwork: "assets/2.jpg" },
        { src: "/made4u.mp3", title: "made4u", artist: "paul", artwork: "assets/3.jpg" },
        { src: "/candyrella.mp3", title: "candyrella", artist: "paul", artwork: "assets/4.jpg" }
    ];
    let currentSongIndex = 0;

    // --- Pemain Audio HTML5 ---
    const audioPlayer = document.getElementById('main-audio-player');
    const albumArtEl = document.getElementById('albumArt');
    const songTitleEl = document.getElementById('songTitle');
    const songArtistEl = document.getElementById('songArtist');
    const musicProgressEl = document.getElementById('musicProgress');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const nextSongBtn = document.getElementById('nextSongBtn');
    const prevSongBtn = document.getElementById('prevSongBtn');
    const playlistContainer = document.getElementById('playlistContainer');

    function loadSong(index, autoplay = false) {
        if (index < 0 || index >= musicPlaylist.length) return;
        currentSongIndex = index;
        const song = musicPlaylist[index];
        audioPlayer.src = song.src;
        updateMusicPlayerUI();
        if (autoplay) {
            audioPlayer.play().catch(e => console.error("Ralat autoplay:", e));
        }
    }

    function updateMusicPlayerUI() {
        const song = musicPlaylist[currentSongIndex];
        songTitleEl.textContent = song.title;
        songArtistEl.textContent = song.artist;
        albumArtEl.src = song.artwork || 'https://placehold.co/60x60/8b5cf6/ffffff?text=Art';
        updatePlayPauseIcon();
    }
    
    function updatePlayPauseIcon() {
        playPauseBtn.innerHTML = audioPlayer.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
    }
    
    function togglePlayPause() {
        if (!audioSystemsInitialized) initAudioSystems(); 
        if (audioPlayer.paused) {
            audioPlayer.play().catch(e => console.error("Ralat play:", e));
        } else {
            audioPlayer.pause();
        }
    }

    function playNextSong() {
        const newIndex = (currentSongIndex + 1) % musicPlaylist.length;
        loadSong(newIndex, true);
    }

    function playPrevSong() {
        const newIndex = (currentSongIndex - 1 + musicPlaylist.length) % musicPlaylist.length;
        loadSong(newIndex, true);
    }
    
    playPauseBtn.addEventListener('click', togglePlayPause);
    nextSongBtn.addEventListener('click', playNextSong);
    prevSongBtn.addEventListener('click', playPrevSong);
    audioPlayer.addEventListener('ended', playNextSong);
    audioPlayer.addEventListener('play', updatePlayPauseIcon);
    audioPlayer.addEventListener('pause', updatePlayPauseIcon);
    audioPlayer.addEventListener('timeupdate', () => {
        if (audioPlayer.duration) {
            const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            musicProgressEl.style.width = `${progressPercent}%`;
        }
    });

    function populatePlaylist() {
        playlistContainer.innerHTML = '';
        musicPlaylist.forEach((song, index) => {
            const div = document.createElement('div');
            div.textContent = `${index + 1}. ${song.title}`;
            div.onclick = () => { if(!audioSystemsInitialized) initAudioSystems(); loadSong(index, true); };
            playlistContainer.appendChild(div);
        });
    }

    function initAudioSystems() { 
        if (audioSystemsInitialized) return;
        audioSystemsInitialized = true;
        console.log("Interaksi pertama dikesan. Memulakan audio...");
        audioPlayer.play().catch(e => {
            console.warn("Autoplay digagalkan oleh pelayar. Ini adalah perkara biasa.", e);
        });
        // Pastikan lagu pertama dimuat jika audio baru saja diinisialisasi
        if(!audioPlayer.src) {
            loadSong(currentSongIndex, true);
        }
    }

    // --- Logik Utama Aplikasi ---
    const screens = { 'home-screen': document.getElementById('home-screen'), 'message-screen': document.getElementById('message-screen'), 'gallery-screen': document.getElementById('gallery-screen'), 'music-screen': document.getElementById('music-screen'), 'tetris-screen': document.getElementById('tetris-screen') };
    let currentVisibleScreen = 'home-screen';

    function showScreen(screenId) {
        if (screens[currentVisibleScreen]) screens[currentVisibleScreen].classList.remove('active');
        if (screens[screenId]) {
            screens[screenId].classList.add('active');
            currentVisibleScreen = screenId;
        }
        
        if (screenId === 'music-screen' && !playlistContainer.hasChildNodes()) {
            populatePlaylist();
        }
    }

    // --- Logik Mesej ---
    const messages = [ "Hai Sayang, Selamat Ulang Tahun ya!", "Semoga panjang umur, sehat selalu...", "Tambah dewasa, tambah bijaksana...", "Semua doa terbaik untukmu!", "I have a little suprise...", "CIEEEE KEPO YAAA WKWKW", "Pokoknya, HAPPY BIRTHDAY!", "I Love You! ;)", "Udah ya, itu aja pesannya. Hehe." ];
    let currentMessageIdx = 0;
    const messageContentEl = document.getElementById('message-content');
    const nextMessageBtn = document.getElementById('nextMessageBtn');
    const skipMessageBtn = document.getElementById('skipMessageBtn');
    function displayMessage() { if (currentMessageIdx < messages.length) { messageContentEl.textContent = messages[currentMessageIdx]; } else { messageContentEl.textContent = "Selesai!"; nextMessageBtn.style.display = 'none'; skipMessageBtn.style.display = 'none';}}
    function startMessages() { currentMessageIdx = 0; nextMessageBtn.style.display = 'block'; skipMessageBtn.style.display = 'block'; displayMessage(); }
    nextMessageBtn.addEventListener('click', () => { currentMessageIdx++; displayMessage(); });
    skipMessageBtn.addEventListener('click', () => { currentMessageIdx = messages.length; displayMessage(); });

    // --- Logik Galeri ---
    const galleryImages = [ 
        { src: "assets/1.jpg", caption: "" }, { src: "assets/2.jpg", caption: "" }, 
        { src: "assets/3.jpg", caption: "" }, { src: "assets/4.jpg", caption: "" }, 
        { src: "assets/5.jpg", caption: "" }, { src: "assets/6.jpg", caption: "" },
        { src: "assets/7.jpg", caption: "" }, { src: "assets/8.jpg", caption: "" },
        { src: "assets/9.jpg", caption: "" }, { src: "assets/10.jpg", caption: "" }, 
        { src: "assets/11.jpg", caption: "" }, { src: "assets/12.jpg", caption: "" }, 
        { src: "assets/13.jpg", caption: "" }, { src: "assets/14.jpg", caption: "" },
        { src: "assets/15.jpg", caption: "" },
        { isVideo: true, embedUrl: "https://drive.google.com/file/d/19m5TIGXGlVbp-oSdvgs4VpEn3a9SWDyJ/preview", caption: "Hehe" }
    ];
    let currentImageIdx = 0;
    const galleryMediaEl = document.getElementById('galleryMedia');
    const galleryCounterEl = document.getElementById('galleryCounter');
    const galleryNextBtn = document.getElementById('nextImageBtn');

    function displayImage() {
        if (galleryImages.length === 0) return;
        const imgData = galleryImages[currentImageIdx];
        galleryMediaEl.innerHTML = ''; 

        if (imgData.isVideo) {
            const iframe = document.createElement('iframe');
            iframe.src = imgData.embedUrl;
            iframe.width = "100%";
            iframe.height = "150";
            iframe.allow = "autoplay";
            iframe.allowFullscreen = true;
            iframe.style.border = "0";
            galleryMediaEl.appendChild(iframe);
        } else {
            const img = document.createElement('img');
            img.src = imgData.src;
            img.alt = "Memuat...";
            img.style.maxWidth = "100%";
            img.style.maxHeight = "150px";
            img.style.border = "2px solid #9effae";
            img.style.margin = "10px auto";
            img.style.display = "block";
            img.style.objectFit = "contain";
            img.style.backgroundColor = "#1e2b22";
            img.onerror = () => {
                img.src = `https://placehold.co/200x150/ef4444/ffffff?text=Gagal+Muat`;
                img.alt = 'Gagal memuat gambar';
            };
            galleryMediaEl.appendChild(img);
        }
        galleryCounterEl.textContent = `Media ${currentImageIdx + 1} dari ${galleryImages.length}`;
    }
    function startGallery() { currentImageIdx = 0; if (galleryImages.length > 0) displayImage(); }
    galleryNextBtn.addEventListener('click', () => { if (galleryImages.length > 0) { currentImageIdx = (currentImageIdx + 1) % galleryImages.length; displayImage(); } });
    
    // --- Logik Tetris (DIPERBAIKI & DIRAPIKAN) ---
    const tetrisGridEl = document.getElementById('tetris-grid');
    const tetrisScoreEl = document.getElementById('tetrisScore');
    const tetrisLevelEl = document.getElementById('tetrisLevel');
    const tetrisLinesEl = document.getElementById('tetrisLines');
    const tetrisStartBtn = document.getElementById('tetrisStartBtn');
    const tetrisLeftBtn = document.getElementById('tetrisLeftBtn');
    const tetrisRightBtn = document.getElementById('tetrisRightBtn');
    const tetrisRotateBtn = document.getElementById('tetrisRotateBtn');
    const gameOverEl = document.getElementById('tetris-game-over');

    const GRID_WIDTH = 10;
    const GRID_HEIGHT = 18;
    let tetrisGrid = [];
    let score = 0;
    let level = 1;
    let linesCleared = 0;
    let gameInterval;
    let currentPiece;
    let currentRow;
    let currentCol;
    let gameRunning = false;

    const TETROMINOES = {
        'I': { shape: [[1, 1, 1, 1]], color: 'filledI' },
        'L': { shape: [[1, 0, 0], [1, 1, 1]], color: 'filledL' },
        'J': { shape: [[0, 0, 1], [1, 1, 1]], color: 'filledJ' },
        'T': { shape: [[0, 1, 0], [1, 1, 1]], color: 'filledT' },
        'S': { shape: [[0, 1, 1], [1, 1, 0]], color: 'filledS' },
        'Z': { shape: [[1, 1, 0], [0, 1, 1]], color: 'filledZ' },
        'O': { shape: [[1, 1], [1, 1]], color: 'filledO' }
    };
    const PIECE_KEYS = Object.keys(TETROMINOES);

    function createTetrisGrid() {
        tetrisGridEl.innerHTML = '';
        tetrisGrid = [];
        for (let r = 0; r < GRID_HEIGHT; r++) {
            tetrisGrid[r] = [];
            for (let c = 0; c < GRID_WIDTH; c++) {
                const cell = document.createElement('div');
                cell.classList.add('tetris-cell');
                tetrisGridEl.appendChild(cell);
                tetrisGrid[r][c] = { element: cell, filled: null };
            }
        }
    }

    function drawGrid() {
        for (let r = 0; r < GRID_HEIGHT; r++) {
            for (let c = 0; c < GRID_WIDTH; c++) {
                tetrisGrid[r][c].element.className = 'tetris-cell'; // Reset
                if (tetrisGrid[r][c].filled) {
                    tetrisGrid[r][c].element.classList.add(tetrisGrid[r][c].filled);
                }
            }
        }
    }

    function drawPiece() {
        currentPiece.shape.forEach((row, r) => {
            row.forEach((value, c) => {
                if (value) {
                    const gridRow = currentRow + r;
                    const gridCol = currentCol + c;
                    if (gridRow >= 0 && gridRow < GRID_HEIGHT && gridCol >= 0 && gridCol < GRID_WIDTH) {
                        tetrisGrid[gridRow][gridCol].element.classList.add(currentPiece.color);
                    }
                }
            });
        });
    }

    function checkCollision(row, col, pieceShape) {
        for (let r = 0; r < pieceShape.length; r++) {
            for (let c = 0; c < pieceShape[r].length; c++) {
                if (pieceShape[r][c]) {
                    let newRow = row + r;
                    let newCol = col + c;
                    // Check boundaries and if the cell is already filled
                    if (newRow >= GRID_HEIGHT || newCol < 0 || newCol >= GRID_WIDTH || (newRow >= 0 && tetrisGrid[newRow][newCol].filled)) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function spawnPiece() {
        const pieceKey = PIECE_KEYS[Math.floor(Math.random() * PIECE_KEYS.length)];
        currentPiece = JSON.parse(JSON.stringify(TETROMINOES[pieceKey])); // Deep copy
        currentRow = 0;
        currentCol = Math.floor(GRID_WIDTH / 2) - Math.floor(currentPiece.shape[0].length / 2);
        if (checkCollision(currentRow, currentCol, currentPiece.shape)) {
            gameOver();
        }
    }

    function lockPiece() {
        currentPiece.shape.forEach((row, r) => {
            row.forEach((value, c) => {
                if (value) {
                    const gridRow = currentRow + r;
                    const gridCol = currentCol + c;
                    if (gridRow >= 0 && gridRow < GRID_HEIGHT && gridCol >= 0 && gridCol < GRID_WIDTH) {
                        tetrisGrid[gridRow][gridCol].filled = currentPiece.color;
                    }
                }
            });
        });
        clearLines();
    }

    function clearLines() {
        let linesRemoved = 0;
        for (let r = GRID_HEIGHT - 1; r >= 0; r--) {
            if (tetrisGrid[r].every(cell => cell.filled)) {
                linesRemoved++;
                // Move all rows above down
                for (let rowAbove = r; rowAbove > 0; rowAbove--) {
                    for (let c = 0; c < GRID_WIDTH; c++) {
                        tetrisGrid[rowAbove][c].filled = tetrisGrid[rowAbove - 1][c].filled;
                    }
                }
                // Clear top row
                for (let c = 0; c < GRID_WIDTH; c++) {
                    tetrisGrid[0][c].filled = null;
                }
                r++; // Check the same row again after shifting
            }
        }
        if (linesRemoved > 0) {
            score += (100 * linesRemoved) * level;
            linesCleared += linesRemoved;
            if (linesCleared > 0 && linesCleared % 10 === 0) {
                level++;
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, Math.max(100, 800 - (50 * (level - 1))));
            }
            updateTetrisUI();
        }
    }
    
    function moveDown() {
        if (!gameRunning) return;
        if (checkCollision(currentRow + 1, currentCol, currentPiece.shape)) {
            lockPiece();
            spawnPiece();
        } else {
            currentRow++;
        }
        drawGrid(); // Redraw entire grid
        drawPiece(); // Then draw the piece at new location
    }

    function moveHorizontal(direction) {
        if (!gameRunning) return;
        if (!checkCollision(currentRow, currentCol + direction, currentPiece.shape)) {
            currentCol += direction;
        }
        drawGrid();
        drawPiece();
    }
    
    function rotatePiece() {
        if (!gameRunning) return;
        const shape = currentPiece.shape;
        const numRows = shape.length;
        const numCols = shape[0].length;
        const newShape = Array(numCols).fill(null).map(() => Array(numRows).fill(0));

        for (let r = 0; r < numRows; r++) {
            for (let c = 0; c < numCols; c++) {
                newShape[c][numRows - 1 - r] = shape[r][c];
            }
        }

        if (!checkCollision(currentRow, currentCol, newShape)) {
            currentPiece.shape = newShape;
        }
        drawGrid();
        drawPiece();
    }

    function updateTetrisUI() {
        tetrisScoreEl.textContent = score;
        tetrisLevelEl.textContent = level;
        tetrisLinesEl.textContent = linesCleared;
    }

    function gameOver() {
        clearInterval(gameInterval);
        gameRunning = false;
        tetrisStartBtn.textContent = "MULAI LAGI";
        gameOverEl.innerHTML = `GAME OVER<br><span style="font-size: 0.6em;">Skor: ${score}</span>`;
        gameOverEl.style.display = 'flex';
    }

    function gameLoop() {
        if(gameRunning) {
             moveDown();
        }
    }

    function startTetrisGame() {
        if (gameInterval) clearInterval(gameInterval);
        gameOverEl.style.display = 'none';
        createTetrisGrid();
        score = 0;
        level = 1;
        linesCleared = 0;
        updateTetrisUI();
        spawnPiece();
        drawGrid();
        drawPiece();
        gameRunning = true;
        tetrisStartBtn.textContent = "BERMAIN...";
        gameInterval = setInterval(gameLoop, 800);
    }

    function initTetris() {
        if (!gameRunning) {
            createTetrisGrid();
            updateTetrisUI();
            tetrisStartBtn.textContent = "MULAI GAME";
        }
    }

    tetrisStartBtn.addEventListener('click', startTetrisGame);
    tetrisLeftBtn.addEventListener('click', () => moveHorizontal(-1));
    tetrisRightBtn.addEventListener('click', () => moveHorizontal(1));
    tetrisRotateBtn.addEventListener('click', rotatePiece);

    // --- Kontrol D-Pad dan Tombol Aksi ---
    document.getElementById('dpadUp').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen') rotatePiece(); });
    document.getElementById('dpadLeft').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen') moveHorizontal(-1); });
    document.getElementById('dpadRight').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen') moveHorizontal(1); });
    document.getElementById('dpadDown').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen') moveDown(); });
    document.getElementById('buttonA').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen') rotatePiece(); });
    document.getElementById('buttonB').addEventListener('click', () => { if (currentVisibleScreen === 'tetris-screen') moveDown(); });

    // --- Inisialisasi Utama ---
    loadSong(0); // Muat lagu pertama
    startMessages(); // Tampilkan pesan pertama
    
    // Menunggu interaksi pengguna pertama untuk memulakan audio
    ['click', 'touchstart', 'keydown'].forEach(eventName => { 
        document.body.addEventListener(eventName, initAudioSystems, { once: true });
    });

</script>
</body>
</html>
