<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kejutan Ulang Tahun Retro!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Font - Press Start 2P (Pixel Font) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #4f00bc, #2a0052, #1a0033);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .console-body {
            background-color: #e0e0e0; /* Light grey */
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 0 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 380px; /* Max width for console */
            position: relative;
        }

        .console-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
        }

        .power-led {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            box-shadow: 0 0 5px red;
        }

        .brand-name {
            font-size: 0.6em;
            color: #555;
        }

        .screen-area {
            background-color: #25392b; /* Dark green like old LCD */
            border: 4px solid #1a1a1a; /* Dark bezel */
            border-radius: 8px;
            height: 220px; /* Fixed height for screen */
            margin-bottom: 20px;
            padding: 15px;
            color: #9effae; /* Light green text */
            overflow-y: auto; /* Scroll if content overflows */
            position: relative;
            font-size: 0.7em; /* Smaller text on screen */
            line-height: 1.5;
            background-image: repeating-linear-gradient(
                transparent,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
        }
        .screen-area::-webkit-scrollbar { width: 8px; }
        .screen-area::-webkit-scrollbar-track { background: #25392b; }
        .screen-area::-webkit-scrollbar-thumb { background: #9effae; border-radius: 4px; }

        .controls-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-buttons-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }

        .main-button {
            padding: 10px 5px; border-radius: 8px; color: white; text-align: center;
            font-size: 0.7em; border: none;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2), inset 0 -2px 0 rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.1s ease;
        }
        .main-button:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }

        .btn-message { background-color: #3b82f6; } .btn-gallery { background-color: #ef4444; }
        .btn-music { background-color: #8b5cf6; } .btn-tetris { background-color: #22c55e; }

        .d-pad-container { display: flex; justify-content: center; align-items: center; }
        .d-pad {
            display: grid; grid-template-areas: ". up ." "left center right" ". down .";
            width: 90px; height: 90px;
        }
        .d-pad button {
            background-color: #4a4a4a; border: 1px solid #333; color: white;
            display: flex; align-items: center; justify-content: center;
        }
        .d-pad button:active { background-color: #333; }
        .d-pad .up { grid-area: up; border-radius: 5px 5px 0 0; }
        .d-pad .down { grid-area: down; border-radius: 0 0 5px 5px; }
        .d-pad .left { grid-area: left; border-radius: 5px 0 0 5px; }
        .d-pad .right { grid-area: right; border-radius: 0 5px 5px 0; }
        .d-pad .center { grid-area: center; background-color: #3a3a3a; }

        .action-buttons-container { display: flex; flex-direction: column; justify-content: space-around; align-items: center; }
        .action-button {
            width: 45px; height: 45px; border-radius: 50%; background-color: #d9534f;
            color: white; font-size: 1em; border: 2px solid #a94442;
            box-shadow: 0 3px 0 #792421; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .action-button:active { transform: translateY(2px); box-shadow: 0 1px 0 #792421; }
        .action-button.b-button { margin-bottom: 10px;}

        .bottom-controls { display: flex; justify-content: space-around; align-items: center; margin-top: 15px; }
        .control-btn-sm {
            background-color: #6c757d; color: white; padding: 6px 12px;
            border-radius: 15px; font-size: 0.6em; border: none;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        .control-btn-sm:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        
        .screen-content { display: none; height: 100%; }
        .screen-content.active { display: block; }

        .nav-button {
            padding: 8px 10px; font-size: 0.8em; border-radius: 5px; color: white;
            border: none; margin-top:10px; cursor: pointer; display: block;
            width: 100%; text-align: center; box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .nav-button:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        .btn-next { background-color: #22c55e; } .btn-back { background-color: #ef4444; }
        .btn-skip { background-color: #6b7280; margin-top: 5px; }

        #galleryImage {
            max-width: 100%; max-height: 120px; border: 2px solid #9effae;
            margin: 10px auto; display: block; object-fit: contain; background-color: #1e2b22; 
        }

        .music-player img { width: 60px; height: 60px; border: 1px solid #9effae; margin: 0 auto 5px auto; display:block; }
        .music-player .song-title { font-size: 0.8em; margin-bottom: 2px; text-align: center;}
        .music-player .song-artist { font-size: 0.7em; margin-bottom: 5px; text-align: center;}
        .music-player .progress-bar { width: 100%; height: 5px; background: #555; margin-bottom: 5px; border-radius: 2px;}
        .music-player .progress { width: 0%; height: 100%; background: #9effae; border-radius: 2px;}
        .music-player .controls { display: flex; justify-content: space-around; margin-bottom: 5px;}
        .music-player .controls button { background: none; border: none; color: #9effae; font-size: 1.2em; cursor: pointer;}
        .music-player .playlist { font-size: 0.6em; max-height: 50px; overflow-y: auto; border-top: 1px solid #555; padding-top: 5px;}
        .music-player .playlist div { padding: 2px 0; cursor: pointer; }
        .music-player .playlist div:hover { background-color: rgba(158,255,174,0.2); }

        #tetris-grid {
            display: grid; grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(18, 1fr);    
            width: 100%; height: 160px; border: 1px solid #9effae;
            background-color: #1e2b22; margin-bottom: 5px;
        }
        .tetris-cell { border: 1px solid #25392b; }
        .tetris-cell.filledI { background-color: cyan; } .tetris-cell.filledL { background-color: orange; }
        .tetris-cell.filledJ { background-color: blue; } .tetris-cell.filledT { background-color: purple; }
        .tetris-cell.filledS { background-color: lime; } .tetris-cell.filledZ { background-color: red; }
        .tetris-cell.filledO { background-color: yellow; }

        .tetris-controls { display: flex; justify-content: space-around; margin-top: 5px; }
        .tetris-controls button {
            background-color: #555; color: #9effae; border: 1px solid #9effae;
            padding: 3px 6px; font-size: 0.6em; border-radius: 3px;
        }
        .start-game-btn { background-color: #16a34a !important; color: white !important; width: 100%; margin-top: 5px;}
        #home-screen h1 { font-size: 0.9em; margin-bottom: 10px; text-align:center; }
        #home-screen p { font-size: 0.7em; text-align:center; }
    </style>
</head>
<body>
    <div class="console-body">
        <div class="console-top-bar">
            <div class="power-led"></div>
            <div class="brand-name">NEXTIME-BOY</div>
            <div></div> 
        </div>

        <div id="screen" class="screen-area">
            <div id="home-screen" class="screen-content active">
                <h1>Happy Birthday!</h1>
                <p>Pilih menu di bawah</p>
            </div>
            <div id="message-screen" class="screen-content">
                <h2 class="text-center text-lg mb-2">Pesan Untukmu</h2>
                <div id="message-content" class="mb-2 text-sm">Hai Cei, Selamat Ulang Tahun ya!</div>
                <button id="nextMessageBtn" class="nav-button btn-next">Selanjutnya</button>
                <button id="skipMessageBtn" class="nav-button btn-skip">Lewati Semua</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>
            <div id="gallery-screen" class="screen-content">
                <h2 class="text-center text-lg mb-1">Galeri Foto</h2>
                <p class="text-xs text-center mb-1" id="gallery-title">HEYML PHOTOSBOX</p>
                <img id="galleryImage" src="assets/1.jpg" alt="Foto Galeri">
                <p id="galleryCounter" class="text-xs text-center my-1">Mencetak foto 1 dari 5...</p>
                <button id="nextImageBtn" class="nav-button btn-next">Selanjutnya</button>
                <button id="printImageBtn" class="nav-button btn-skip">Mulai Cetak</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>
            <div id="music-screen" class="screen-content music-player">
                <h2 class="text-center text-lg mb-1">Pemutar Musik</h2>
                <img id="albumArt" src="https://placehold.co/60x60/25392b/9effae?text=Art" alt="Album Art">
                <div id="songTitle" class="song-title">Lagu Pilihan</div>
                <div id="songArtist" class="song-artist">Artisnya</div>
                <div class="progress-bar"><div id="musicProgress" class="progress"></div></div>
                <div class="controls">
                    <button id="prevSongBtn"><i class="fas fa-backward"></i></button>
                    <button id="playPauseBtn"><i class="fas fa-play"></i></button>
                    <button id="nextSongBtn"><i class="fas fa-forward"></i></button>
                </div>
                <div class="playlist" id="playlistContainer"></div>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back mt-2">Kembali</button>
            </div>
            <div id="tetris-screen" class="screen-content">
                <div class="flex justify-between text-xs mb-1">
                    <span>SKOR: <span id="tetrisScore">0</span></span>
                    <span>LEVEL: <span id="tetrisLevel">1</span></span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span>GARIS: <span id="tetrisLines">0</span></span>
                </div>
                <div id="tetris-grid"></div>
                <div class="tetris-controls text-center">
                    <button id="tetrisLeftBtn">&lt;</button>
                    <button id="tetrisRotateBtn">ROTASI</button>
                    <button id="tetrisRightBtn">&gt;</button>
                </div>
                 <button id="tetrisStartBtn" class="nav-button start-game-btn">MULAI GAME</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>
        </div>

        <div class="menu-buttons-grid">
            <button onclick="showScreen('message-screen'); startMessages();" class="main-button btn-message">PESAN</button>
            <button onclick="showScreen('gallery-screen'); startGallery();" class="main-button btn-gallery">GALERI</button>
            <button onclick="showScreen('music-screen'); startInternalMusicPlayer();" class="main-button btn-music">MUSIK</button>
            <button onclick="showScreen('tetris-screen'); initTetris();" class="main-button btn-tetris">TETRIS</button>
        </div>

        <div class="controls-area">
            <div class="d-pad-container">
                <div class="d-pad">
                    <button class="up" id="dpadUp"><i class="fas fa-caret-up"></i></button>
                    <button class="left" id="dpadLeft"><i class="fas fa-caret-left"></i></button>
                    <button class="center"></button>
                    <button class="right" id="dpadRight"><i class="fas fa-caret-right"></i></button>
                    <button class="down" id="dpadDown"><i class="fas fa-caret-down"></i></button>
                </div>
            </div>
            <div class="action-buttons-container">
                <button class="action-button b-button" id="buttonB">B</button>
                <button class="action-button a-button" id="buttonA">A</button>
            </div>
        </div>

        <div class="bottom-controls">
            <button class="control-btn-sm">SELECT</button>
            <button class="control-btn-sm">START</button>
            <div class="text-xs text-gray-600">...</div>
        </div>
    </div>

<script>
    const screenContainer = document.getElementById('screen');
    const screens = {
        'home-screen': document.getElementById('home-screen'),
        'message-screen': document.getElementById('message-screen'),
        'gallery-screen': document.getElementById('gallery-screen'),
        'music-screen': document.getElementById('music-screen'),
        'tetris-screen': document.getElementById('tetris-screen')
    };
    let currentVisibleScreen = 'home-screen';
    
    // --- Background Music (Local Files) ---
    const backgroundPlaylist = [ // Ganti dengan path fail muzik anda
        "assets/muzik_latar1.mp3",
        "assets/muzik_latar2.mp3",
        // Tambah lebih banyak fail muzik di sini
    ];
    let currentBackgroundSongIndex = 0;
    let isBackgroundMusicPlaying = false;
    let backgroundMusicInitialized = false;
    const backgroundMusicPlayer = new Tone.Player({
        // url akan ditetapkan oleh loadAndPlayBackgroundSong
        loop: false, // Kita akan mengendalikan loop atau lagu seterusnya secara manual
        onload: () => {
            console.log("Fail muzik latar '" + backgroundPlaylist[currentBackgroundSongIndex] + "' dimuat.");
            if (isBackgroundMusicPlaying) { // Jika diarahkan untuk main selepas muat
                backgroundMusicPlayer.start();
            }
        },
        onstop: () => { // Dipanggil apabila lagu selesai (jika loop=false)
            console.log("Muzik latar selesai:", backgroundPlaylist[currentBackgroundSongIndex]);
            if (isBackgroundMusicPlaying) { // Hanya mainkan seterusnya jika memang sepatutnya main
                 playNextBackgroundSong();
            }
        },
        onerror: (e) => console.error("Ralat memuat muzik latar:", backgroundPlaylist[currentBackgroundSongIndex], e)
    }).toDestination();
    backgroundMusicPlayer.volume.value = -6; // Kurangkan volume muzik latar (dalam dB)


    function loadAndPlayBackgroundSong(index) {
        if (index >= 0 && index < backgroundPlaylist.length) {
            currentBackgroundSongIndex = index;
            const songUrl = backgroundPlaylist[index];
            console.log("Cuba memuat muzik latar:", songUrl);
            // Hentikan pemain semasa sebelum memuat lagu baru
            if (backgroundMusicPlayer.state === "started") {
                backgroundMusicPlayer.stop();
            }
            backgroundMusicPlayer.load(songUrl)
                .then(() => {
                    // Onload akan menangani start jika isBackgroundMusicPlaying true
                    // Jika tidak, ia hanya akan dimuatkan
                    if (!isBackgroundMusicPlaying) { // Jika tidak sepatutnya main, pastikan ia tidak auto-start
                         console.log("Muzik latar dimuat tetapi tidak dimainkan (dijeda).");
                    }
                })
                .catch(e => console.error("Pengecualian semasa memuat muzik latar:", e));
        } else {
            console.warn("Indeks lagu latar tidak valid:", index);
            isBackgroundMusicPlaying = false; // Hentikan main jika indeks tidak valid
        }
    }

    function playNextBackgroundSong() {
        let nextIndex = (currentBackgroundSongIndex + 1) % backgroundPlaylist.length;
        loadAndPlayBackgroundSong(nextIndex);
    }

    function startBackgroundMusic() {
        if (!isBackgroundMusicPlaying && backgroundPlaylist.length > 0) {
            console.log("Memulakan muzik latar...");
            isBackgroundMusicPlaying = true;
            loadAndPlayBackgroundSong(currentBackgroundSongIndex); // Muat dan mainkan lagu semasa atau pertama
        }
    }

    function pauseBackgroundMusic() {
        if (isBackgroundMusicPlaying && backgroundMusicPlayer.loaded && backgroundMusicPlayer.state === "started") {
            backgroundMusicPlayer.stop(); // Menggunakan stop agar onstop boleh trigger lagu seterusnya jika perlu
            console.log("Muzik latar dijeda (menggunakan stop).");
            // isBackgroundMusicPlaying tetap true, menandakan ia sepatutnya main apabila disambung
        }
    }

    function resumeBackgroundMusic() {
        if (isBackgroundMusicPlaying && backgroundMusicPlayer.loaded && backgroundMusicPlayer.state !== "started") {
            console.log("Menyambung semula muzik latar...");
            backgroundMusicPlayer.start();
        } else if (isBackgroundMusicPlaying && !backgroundMusicPlayer.loaded && backgroundPlaylist.length > 0) {
            // Jika dijeda sebelum sempat muat, cuba muat dan mainkan semula
            console.log("Muzik latar belum dimuat, cuba muat dan mainkan semula...");
            loadAndPlayBackgroundSong(currentBackgroundSongIndex);
        }
    }
    // --- End of Background Music ---


    // --- Internal Music Player (Tone.Player untuk playlist di skrin "MUSIK") ---
    const internalMusicPlayer = new Tone.Player({
        onload: () => console.log("Fail lagu internal dimuat."),
        onerror: (e) => console.error("Ralat memuat fail lagu internal:", e)
    }).toDestination();
    let internalMusicSynth; // Jika anda ingin menambah semula lagu synth seperti Happy Birthday
    
    // Senarai main untuk Pemutar Musik Internal
    const internalPlaylist = [
        // Contoh, anda boleh menggunakan fail lokal atau URL eksternal yang berfungsi
        { title: "On Bended Knee", artist: "Boyz II Men", src: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/music/on-bended-knee.mp3", duration: 329 },
        { title: "Nothings Gonna Change My Love", artist: "George Benson", src: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/music/nothings-gonna-change-my-love-for-you.mp3", duration: 243 },
        { title: "Lagu Lokal Contoh", artist: "Saya Sendiri", src: "assets/Paul_Partohap_VITAMIN U.mp3", duration: 250 } // Contoh fail lokal
    ];
    let currentInternalSongIndex = 0;
    let isInternalMusicPlaying = false;
    let internalMusicInterval;
    // --- End of Internal Music Player Variables ---


    function initializeGlobalAudio() { // Dipanggil pada interaksi pengguna pertama
        if (backgroundMusicInitialized) return;

        if (Tone.context.state !== 'running') {
            Tone.start().then(() => {
                console.log("Konteks Audio Tone.js berjaya dimulakan.");
                startBackgroundMusic(); // Mulakan muzik latar selepas Tone.js sedia
            }).catch(e => {
                console.warn("Gagal memulakan Tone.js AudioContext:", e);
            });
        } else {
            startBackgroundMusic(); // Jika Tone.js sudah berjalan, terus mulakan muzik latar
        }
        backgroundMusicInitialized = true;
    }
    
    function playClickSound() { // Kini hanya untuk memulakan audio global jika belum
        if (!backgroundMusicInitialized) {
            initializeGlobalAudio();
        } else if (Tone.context.state !== 'running') { // Jika Tone.js berhenti atas sebab tertentu
            Tone.start().catch(e => console.warn("Tone.start gagal pada klik seterusnya:", e));
        }
    }


    function showScreen(screenId) {
        playClickSound(); // Memastikan audio global diinisialisasi pada interaksi pertama
        
        if (currentVisibleScreen === 'music-screen' && isInternalMusicPlaying) {
            internalMusicPlayer.stop();
            isInternalMusicPlaying = false; 
            updateInternalPlayPauseIcon();
        }
        
        if (screens[currentVisibleScreen]) {
            screens[currentVisibleScreen].classList.remove('active');
        }
        if (screens[screenId]) {
            screens[screenId].classList.add('active');
            currentVisibleScreen = screenId;
        } else {
            console.error("Screen not found:", screenId);
        }

        if (screenId === 'music-screen') {
            pauseBackgroundMusic();
        } else {
            // Hanya sambung semula jika muzik latar sepatutnya bermain dan telah diinisialisasi
            if (backgroundMusicInitialized && isBackgroundMusicPlaying) {
                 resumeBackgroundMusic();
            }
        }
    }

    // --- Message Logic --- (Tidak berubah)
    const messages = ["Hai Cei, ...", /* ... mesej lain ... */];
    let currentMessageIdx = 0;
    const messageContentEl = document.getElementById('message-content');
    const nextMessageBtn = document.getElementById('nextMessageBtn');
    const skipMessageBtn = document.getElementById('skipMessageBtn');
    function displayMessage() { if (currentMessageIdx < messages.length) { messageContentEl.textContent = messages[currentMessageIdx]; } else { messageContentEl.textContent = "Pesan Selesai!"; nextMessageBtn.style.display = 'none'; skipMessageBtn.style.display = 'none';}}
    function startMessages() { currentMessageIdx = 0; nextMessageBtn.style.display = 'block'; skipMessageBtn.style.display = 'block'; displayMessage(); }
    nextMessageBtn.addEventListener('click', () => { playClickSound(); currentMessageIdx++; displayMessage(); });
    skipMessageBtn.addEventListener('click', () => { playClickSound(); currentMessageIdx = messages.length -1; displayMessage(); });

    // --- Gallery Logic --- (Tidak berubah, menggunakan asset/N.jpg)
    const galleryImages = [
        { src: "assets/1.jpg", caption: "Foto Kenangan 1" }, { src: "assets/2.jpg", caption: "Foto Kenangan 2" },
        { src: "assets/3.jpg", caption: "Foto Kenangan 3" }, { src: "assets/4.jpg", caption: "Foto Kenangan 4" },
        { src: "assets/5.jpg", caption: "Foto Kenangan 5" }
    ];
    let currentImageIdx = 0;
    const galleryImageEl = document.getElementById('galleryImage');
    const galleryCounterEl = document.getElementById('galleryCounter');
    function displayImage() {
        if (galleryImages.length === 0) { /* ... */ return; }
        const imgData = galleryImages[currentImageIdx]; const imagePath = imgData.src;
        galleryImageEl.onload = function() { this.alt = imgData.caption; };
        galleryImageEl.onerror = function() { this.src = 'https://placehold.co/150x100/FF0000/FFFFFF?text=RALAT+FAIL'; this.alt = 'Gagal: ' + imagePath; this.onerror = null; };
        galleryImageEl.src = imagePath; galleryImageEl.alt = "Memuat: " + imgData.caption;
        galleryCounterEl.textContent = `Foto ${currentImageIdx + 1} dari ${galleryImages.length}: ${imgData.caption}`;
    }
    function startGallery() { currentImageIdx = 0; if (galleryImages.length > 0) displayImage(); else { /* ... */ } }
    nextImageBtn.addEventListener('click', () => { playClickSound(); if (galleryImages.length > 0) { currentImageIdx = (currentImageIdx + 1) % galleryImages.length; displayImage(); } });
    printImageBtn.addEventListener('click', () => { playClickSound(); if (galleryImages.length > 0) alert(`"Mencetak" ${galleryImages[currentImageIdx].caption}`); else alert("Tiada foto"); });

    // --- Internal Music Player UI Elements & Functions ---
    const albumArtEl = document.getElementById('albumArt');
    const songTitleEl = document.getElementById('songTitle');
    const songArtistEl = document.getElementById('songArtist');
    const musicProgressEl = document.getElementById('musicProgress');
    const internalPlayPauseBtn = document.getElementById('playPauseBtn');
    const internalNextSongBtn = document.getElementById('nextSongBtn');
    const internalPrevSongBtn = document.getElementById('prevSongBtn');
    const internalPlaylistContainerEl = document.getElementById('playlistContainer');

    function formatTime(seconds) { const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }

    function loadInternalSong(songIndex) {
        clearInterval(internalMusicInterval);
        musicProgressEl.style.width = '0%';
        const song = internalPlaylist[songIndex];
        currentInternalSongIndex = songIndex; 
        songTitleEl.textContent = song.title;
        songArtistEl.textContent = song.artist;
        albumArtEl.src = `https://placehold.co/60x60/25392b/9effae?text=${song.artist.substring(0,3)}`; 

        internalMusicPlayer.load(song.src)
            .then(() => { 
                console.log("Lagu internal '" + song.title + "' dimuat"); 
                if(isInternalMusicPlaying) { 
                    internalMusicPlayer.start();
                    startInternalMusicProgressBar();
                }
            })
            .catch(e => console.error("Ralat memuat lagu internal: ", song.title, e));
        updateInternalPlayPauseIcon();
    }
        
    function startInternalMusicProgressBar() {
        clearInterval(internalMusicInterval);
        let progress = 0;
        if (currentInternalSongIndex < 0 || currentInternalSongIndex >= internalPlaylist.length) return;
        const songDuration = internalPlaylist[currentInternalSongIndex].duration; 
        if (songDuration <= 0) { musicProgressEl.style.width = '0%'; return; }
        
        if (internalMusicPlayer.loaded && isInternalMusicPlaying) {
            internalMusicInterval = setInterval(() => {
                let currentTime = 0; 
                if (internalMusicPlayer.loaded && internalMusicPlayer.state === "started") { 
                     if (internalMusicPlayer.buffer && internalMusicPlayer.buffer.duration) {
                         currentTime = internalMusicPlayer.now() % internalMusicPlayer.buffer.duration;
                     } else { currentTime = progress; progress++; }
                } else { clearInterval(internalMusicInterval); return; }
                let percent = (currentTime / songDuration) * 100;
                musicProgressEl.style.width = `${Math.min(percent, 100)}%`;
                if (percent >= 100) {
                    clearInterval(internalMusicInterval);
                    if (isInternalMusicPlaying) { 
                        isInternalMusicPlaying = false; updateInternalPlayPauseIcon(); musicProgressEl.style.width = '0%'; 
                    }
                }
            }, 1000);
        }
    }

    function updateInternalPlayPauseIcon() { 
        internalPlayPauseBtn.innerHTML = isInternalMusicPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    }
    
    function togglePlayPauseInternalMusic() {
        playClickSound(); // Memastikan audio global diinisialisasi
        if (currentInternalSongIndex < 0 || currentInternalSongIndex >= internalPlaylist.length) { console.warn("Indeks lagu internal tidak valid."); return; }
        
        pauseBackgroundMusic(); // Pastikan muzik latar dijeda

        if (internalMusicPlayer.loaded) {
            if (isInternalMusicPlaying) {
                internalMusicPlayer.stop();
                clearInterval(internalMusicInterval);
            } else {
                internalMusicPlayer.start();
                startInternalMusicProgressBar();
            }
            isInternalMusicPlaying = !isInternalMusicPlaying;
        } else {
            console.warn("Lagu internal belum dimuat.");
            if (!internalMusicPlayer.loaded && internalMusicPlayer.buffer === null) { 
                loadInternalSong(currentInternalSongIndex); 
            }
        }
        updateInternalPlayPauseIcon();
    }

    internalPlayPauseBtn.addEventListener('click', togglePlayPauseInternalMusic);
    internalNextSongBtn.addEventListener('click', () => { playClickSound(); pauseBackgroundMusic(); let newIndex = (currentInternalSongIndex + 1) % internalPlaylist.length; isInternalMusicPlaying = false; loadInternalSong(newIndex); });
    internalPrevSongBtn.addEventListener('click', () => { playClickSound(); pauseBackgroundMusic(); let newIndex = (currentInternalSongIndex - 1 + internalPlaylist.length) % internalPlaylist.length; isInternalMusicPlaying = false; loadInternalSong(newIndex); });

    function populateInternalPlaylist() {
        internalPlaylistContainerEl.innerHTML = '';
        internalPlaylist.forEach((song, index) => {
            const div = document.createElement('div');
            div.textContent = `${index + 1}. ${song.title} - ${song.artist} (${formatTime(song.duration)})`;
            div.onclick = () => {
                playClickSound(); pauseBackgroundMusic();
                if (isInternalMusicPlaying) { if (internalMusicPlayer.loaded) internalMusicPlayer.stop(); clearInterval(internalMusicInterval); isInternalMusicPlaying = false; updateInternalPlayPauseIcon(); }
                loadInternalSong(index);
            };
            internalPlaylistContainerEl.appendChild(div);
        });
    }

    function startInternalMusicPlayer(){ 
        populateInternalPlaylist();
        if(internalPlaylist.length > 0) {
             loadInternalSong(currentInternalSongIndex < internalPlaylist.length ? currentInternalSongIndex : 0);
        } else {
            songTitleEl.textContent = "Playlist Kosong"; songArtistEl.textContent = "-";
        }
    }

    // --- Tetris Logic (Sama seperti sebelumnya, tiada perubahan diperlukan) ---
    const tetrisGridEl = document.getElementById('tetris-grid'); /* ... semua variabel Tetris ... */
    function createTetrisGrid() { /* ... */ } function drawGrid() { /* ... */ }
    function drawPiece() { /* ... */ } function undrawPiece() { /* ... */ }
    function spawnPiece() { /* ... */ } function checkCollision(r,c,pS) { /* ... */ }
    function lockPiece() { /* ... */ } function clearLines() { /* ... */ }
    function moveDown() { /* ... */ } function moveHorizontal(dir) { /* ... */ }
    function rotatePiece() { /* ... */ } function updateTetrisUI() { /* ... */ }
    function gameOver() { /* ... */ } function gameLoop() { /* ... */ }
    function startTetrisGame() { playClickSound(); /* ... */ } function initTetris() { /* ... */ }
    tetrisStartBtn.addEventListener('click', startTetrisGame);
    tetrisLeftBtn.addEventListener('click', () => moveHorizontal(-1));
    tetrisRightBtn.addEventListener('click', () => moveHorizontal(1));
    tetrisRotateBtn.addEventListener('click', rotatePiece);
    document.getElementById('dpadUp').addEventListener('click', rotatePiece);
    document.getElementById('dpadLeft').addEventListener('click', () => moveHorizontal(-1));
    document.getElementById('dpadRight').addEventListener('click', () => moveHorizontal(1));
    document.getElementById('dpadDown').addEventListener('click', () => { if(gameRunning) moveDown(); });
    document.getElementById('buttonA').addEventListener('click', rotatePiece); 
    document.getElementById('buttonB').addEventListener('click', () => { if(currentVisibleScreen === 'tetris-screen' && gameRunning) moveDown(); else playClickSound(); });


    // Initialize
    showScreen('home-screen'); 
    ['click', 'touchstart', 'keydown'].forEach(eventName => { // Guna event listener yang sama
        document.body.addEventListener(eventName, initializeGlobalAudio, { once: true });
    });

</script>
</body>
</html>
