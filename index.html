<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kejutan Ulang Tahun Retro!</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Font - Press Start 2P (Pixel Font) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Tone.js for simple sounds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #4f00bc, #2a0052, #1a0033);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .console-body {
            background-color: #e0e0e0; /* Light grey */
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 0 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 380px; /* Max width for console */
            position: relative;
        }

        .console-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
        }

        .power-led {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            box-shadow: 0 0 5px red;
        }

        .brand-name {
            font-size: 0.6em;
            color: #555;
        }

        .screen-area {
            background-color: #25392b; /* Dark green like old LCD */
            border: 4px solid #1a1a1a; /* Dark bezel */
            border-radius: 8px;
            height: 220px; /* Fixed height for screen */
            margin-bottom: 20px;
            padding: 15px;
            color: #9effae; /* Light green text */
            overflow-y: auto; /* Scroll if content overflows */
            position: relative;
            font-size: 0.7em; /* Smaller text on screen */
            line-height: 1.5;
            /* Scanline effect */
            background-image: repeating-linear-gradient(
                transparent,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
        }
        /* Webkit scrollbar styling for screen area */
        .screen-area::-webkit-scrollbar {
            width: 8px;
        }
        .screen-area::-webkit-scrollbar-track {
            background: #25392b;
        }
        .screen-area::-webkit-scrollbar-thumb {
            background: #9effae;
            border-radius: 4px;
        }


        .controls-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .menu-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .main-button {
            padding: 10px 5px;
            border-radius: 8px;
            color: white;
            text-align: center;
            font-size: 0.7em;
            border: none;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2), inset 0 -2px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.1s ease;
        }
        .main-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }

        .btn-message { background-color: #3b82f6; } /* Blue */
        .btn-gallery { background-color: #ef4444; } /* Red */
        .btn-music { background-color: #8b5cf6; } /* Purple */
        .btn-tetris { background-color: #22c55e; } /* Green */

        .d-pad-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .d-pad {
            display: grid;
            grid-template-areas:
                ". up ."
                "left center right"
                ". down .";
            width: 90px; /* D-pad size */
            height: 90px;
        }
        .d-pad button {
            background-color: #4a4a4a; /* Dark grey */
            border: 1px solid #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .d-pad button:active { background-color: #333; }
        .d-pad .up { grid-area: up; border-radius: 5px 5px 0 0; }
        .d-pad .down { grid-area: down; border-radius: 0 0 5px 5px; }
        .d-pad .left { grid-area: left; border-radius: 5px 0 0 5px; }
        .d-pad .right { grid-area: right; border-radius: 0 5px 5px 0; }
        .d-pad .center { grid-area: center; background-color: #3a3a3a; }


        .action-buttons-container {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        .action-button {
            width: 45px; /* A/B button size */
            height: 45px;
            border-radius: 50%;
            background-color: #d9534f; /* Red */
            color: white;
            font-size: 1em;
            border: 2px solid #a94442;
            box-shadow: 0 3px 0 #792421;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #792421;
        }
        .action-button.b-button { margin-bottom: 10px;} /* Space between A and B */


        .bottom-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
        }
        .control-btn-sm {
            background-color: #6c757d; /* Grey */
            color: white;
            padding: 6px 12px;
            border-radius: 15px; /* Pill shape */
            font-size: 0.6em;
            border: none;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        .control-btn-sm:active {
             transform: translateY(1px);
             box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }
        
        .screen-content { display: none; height: 100%; }
        .screen-content.active { display: block; }

        /* Styling for Message/Gallery/Music/Tetris specific buttons */
        .nav-button {
            padding: 8px 10px;
            font-size: 0.8em;
            border-radius: 5px;
            color: white;
            border: none;
            margin-top:10px;
            cursor: pointer;
            display: block; /* Make them block for full width */
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .nav-button:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }

        .btn-next { background-color: #22c55e; } /* Green */
        .btn-back { background-color: #ef4444; } /* Red */
        .btn-skip { background-color: #6b7280; margin-top: 5px; } /* Gray */

        /* Gallery specific */
        #galleryImage {
            max-width: 100%;
            max-height: 120px; /* Limit image height inside screen */
            border: 2px solid #9effae;
            margin: 10px auto;
            display: block;
            object-fit: contain;
        }

        /* Music Player specific */
        .music-player img {
            width: 60px; height: 60px; border: 1px solid #9effae; margin: 0 auto 5px auto; display:block;
        }
        .music-player .song-title { font-size: 0.8em; margin-bottom: 2px; text-align: center;}
        .music-player .song-artist { font-size: 0.7em; margin-bottom: 5px; text-align: center;}
        .music-player .progress-bar { width: 100%; height: 5px; background: #555; margin-bottom: 5px; border-radius: 2px;}
        .music-player .progress { width: 0%; height: 100%; background: #9effae; border-radius: 2px;}
        .music-player .controls { display: flex; justify-content: space-around; margin-bottom: 5px;}
        .music-player .controls button { background: none; border: none; color: #9effae; font-size: 1.2em; cursor: pointer;}
        .music-player .playlist { font-size: 0.6em; max-height: 50px; overflow-y: auto; border-top: 1px solid #555; padding-top: 5px;}
        .music-player .playlist div { padding: 2px 0; cursor: pointer; }
        .music-player .playlist div:hover { background-color: rgba(158,255,174,0.2); }


        /* Tetris specific */
        #tetris-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr); /* 10 columns for Tetris */
            grid-template-rows: repeat(18, 1fr);    /* 18 rows for Tetris */
            width: 100%;
            height: 160px; /* Adjust height to fit cells */
            border: 1px solid #9effae;
            background-color: #1e2b22; /* Slightly darker green for grid bg */
            margin-bottom: 5px;
        }
        .tetris-cell {
            border: 1px solid #25392b; /* Grid lines */
        }
        .tetris-cell.filledI { background-color: cyan; }
        .tetris-cell.filledL { background-color: orange; }
        .tetris-cell.filledJ { background-color: blue; }
        .tetris-cell.filledT { background-color: purple; }
        .tetris-cell.filledS { background-color: lime; }
        .tetris-cell.filledZ { background-color: red; }
        .tetris-cell.filledO { background-color: yellow; }

        .tetris-controls { display: flex; justify-content: space-around; margin-top: 5px; }
        .tetris-controls button {
            background-color: #555; color: #9effae; border: 1px solid #9effae;
            padding: 3px 6px; font-size: 0.6em; border-radius: 3px;
        }
         .start-game-btn { background-color: #16a34a !important; color: white !important; width: 100%; margin-top: 5px;}

        /* Initial Home Screen message */
        #home-screen h1 { font-size: 0.9em; margin-bottom: 10px; text-align:center; }
        #home-screen p { font-size: 0.7em; text-align:center; }

    </style>
</head>
<body>
    <div class="console-body">
        <div class="console-top-bar">
            <div class="power-led"></div>
            <div class="brand-name">NEXTIME-BOY</div>
            <div></div> <!-- Placeholder for symmetry -->
        </div>

        <div id="screen" class="screen-area">
            <!-- Home Screen (Initial) -->
            <div id="home-screen" class="screen-content active">
                <h1>Happy Birthday!</h1>
                <p>Pilih menu di bawah</p>
            </div>

            <!-- Message Screen -->
            <div id="message-screen" class="screen-content">
                <h2 class="text-center text-lg mb-2">Pesan Untukmu</h2>
                <div id="message-content" class="mb-2 text-sm">Hai Cei, Selamat Ulang Tahun ya!</div>
                <button id="nextMessageBtn" class="nav-button btn-next">Selanjutnya</button>
                <button id="skipMessageBtn" class="nav-button btn-skip">Lewati Semua</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>

            <!-- Gallery Screen -->
            <div id="gallery-screen" class="screen-content">
                <h2 class="text-center text-lg mb-1">Galeri Foto</h2>
                <p class="text-xs text-center mb-1" id="gallery-title">HEYML PHOTOSBOX</p>
                <!-- Gambar akan dimuat oleh JavaScript. onerror untuk fallback jika link Google Drive bermasalah -->
                <img id="galleryImage" src="" alt="Foto Galeri" onerror="this.src='https://placehold.co/150x100/25392b/9effae?text=Error+Muat'; this.alt='Gagal memuat gambar';">
                <p id="galleryCounter" class="text-xs text-center my-1">Mencetak foto 1 dari 4...</p>
                <button id="nextImageBtn" class="nav-button btn-next">Selanjutnya</button>
                <button id="printImageBtn" class="nav-button btn-skip">Mulai Cetak</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>

            <!-- Music Player Screen -->
            <div id="music-screen" class="screen-content music-player">
                <h2 class="text-center text-lg mb-1">Pemutar Musik</h2>
                <img id="albumArt" src="https://placehold.co/60x60/25392b/9effae?text=Art" alt="Album Art">
                <div id="songTitle" class="song-title">Lagu Pilihan</div>
                <div id="songArtist" class="song-artist">Artisnya</div>
                <div class="progress-bar"><div id="musicProgress" class="progress"></div></div>
                <div class="controls">
                    <button id="prevSongBtn"><i class="fas fa-backward"></i></button>
                    <button id="playPauseBtn"><i class="fas fa-play"></i></button>
                    <button id="nextSongBtn"><i class="fas fa-forward"></i></button>
                </div>
                <div class="playlist" id="playlistContainer">
                    <!-- Playlist items will be added here by JS -->
                </div>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back mt-2">Kembali</button>
            </div>

            <!-- Tetris Screen -->
            <div id="tetris-screen" class="screen-content">
                <div class="flex justify-between text-xs mb-1">
                    <span>SKOR: <span id="tetrisScore">0</span></span>
                    <span>LEVEL: <span id="tetrisLevel">1</span></span>
                </div>
                <div class="flex justify-between text-xs mb-1">
                    <span>GARIS: <span id="tetrisLines">0</span></span>
                </div>
                <div id="tetris-grid">
                    <!-- Tetris cells will be added here by JS -->
                </div>
                <div class="tetris-controls text-center">
                    <button id="tetrisLeftBtn">&lt;</button>
                    <button id="tetrisRotateBtn">ROTASI</button>
                    <button id="tetrisRightBtn">&gt;</button>
                </div>
                 <button id="tetrisStartBtn" class="nav-button start-game-btn">MULAI GAME</button>
                <button onclick="showScreen('home-screen')" class="nav-button btn-back">Kembali</button>
            </div>
        </div>

        <div class="menu-buttons-grid">
            <button onclick="showScreen('message-screen'); startMessages();" class="main-button btn-message">PESAN</button>
            <button onclick="showScreen('gallery-screen'); startGallery();" class="main-button btn-gallery">GALERI</button>
            <button onclick="showScreen('music-screen'); startMusicPlayer();" class="main-button btn-music">MUSIK</button>
            <button onclick="showScreen('tetris-screen'); initTetris();" class="main-button btn-tetris">TETRIS</button>
        </div>

        <div class="controls-area">
            <div class="d-pad-container">
                <div class="d-pad">
                    <button class="up" id="dpadUp"><i class="fas fa-caret-up"></i></button>
                    <button class="left" id="dpadLeft"><i class="fas fa-caret-left"></i></button>
                    <button class="center"></button>
                    <button class="right" id="dpadRight"><i class="fas fa-caret-right"></i></button>
                    <button class="down" id="dpadDown"><i class="fas fa-caret-down"></i></button>
                </div>
            </div>
            <div class="action-buttons-container">
                <button class="action-button b-button" id="buttonB">B</button>
                <button class="action-button a-button" id="buttonA">A</button>
            </div>
        </div>

        <div class="bottom-controls">
            <button class="control-btn-sm">SELECT</button>
            <button class="control-btn-sm">START</button>
            <div class="text-xs text-gray-600">...</div>
        </div>
    </div>

<script>
    const screenContainer = document.getElementById('screen');
    const screens = {
        'home-screen': document.getElementById('home-screen'),
        'message-screen': document.getElementById('message-screen'),
        'gallery-screen': document.getElementById('gallery-screen'),
        'music-screen': document.getElementById('music-screen'),
        'tetris-screen': document.getElementById('tetris-screen')
    };
    let currentVisibleScreen = 'home-screen';

    // --- Sound Effects with Tone.js ---
    // Efek suara berikut dialih keluar kerana URL sumber tidak dapat diakses
    // const clickSound = new Tone.Player({
    //     url: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/sound/Button-SoundBible.com-1420500901.mp3",
    //     onload: () => console.log("Click sound loaded."),
    //     onerror: (e) => console.error("Error loading click sound:", e)
    // }).toDestination();

    // const tetrisMoveSound = new Tone.Player({
    //     url: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/sound/DM-CGS-21.mp3",
    //     onload: () => console.log("Tetris move sound loaded."),
    //     onerror: (e) => console.error("Error loading tetris move sound:", e)
    // }).toDestination();

    // const tetrisLineClearSound = new Tone.Player({
    //     url: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/sound/tick_002.ogg",
    //     onload: () => console.log("Tetris line clear sound loaded."),
    //     onerror: (e) => console.error("Error loading tetris line clear sound:", e)
    // }).toDestination();
    
    const musicPlayer = new Tone.Player({
        onload: () => console.log("Music file loaded into musicPlayer."),
        onerror: (e) => console.error("Error loading music file into musicPlayer:", e)
    }).toDestination();

    let musicSynth; 

    // Fungsi playTonePlayerSound tidak lagi diperlukan jika semua pemain efek suara dialih keluar
    // function playTonePlayerSound(playerInstance, soundName = "Sound") { ... }

    // Fungsi untuk bunyi klik kini tidak melakukan apa-apa atau boleh diganti dengan alternatif jika ada
    function playClickSound() {
        // console.log("Click sound (disabled)"); // Untuk debugging jika diperlukan
        if (Tone.context.state !== 'running') { // Masih penting untuk memulakan konteks audio untuk musik
             Tone.start().catch(e => console.error("Error starting Tone.js for music:", e));
        }
    }


    function showScreen(screenId) {
        playClickSound(); // Masih panggil untuk memulakan konteks Tone.js jika belum
        if (screens[currentVisibleScreen]) {
            screens[currentVisibleScreen].classList.remove('active');
        }
        if (screens[screenId]) {
            screens[screenId].classList.add('active');
            currentVisibleScreen = screenId;
        } else {
            console.error("Screen not found:", screenId);
        }
    }

    // --- Message Logic ---
    const messages = [
        "Hai Cei, Selamat Ulang Tahun ya!",
        "Semoga panjang umur, sehat selalu...",
        "Tambah dewasa, tambah bijaksana...",
        "Semua doa terbaik untukmu!",
        "Ini ada sedikit kejutan buat kamu...",
        "CIEEEE KEPO YAAA WKWKW",
        "Pokoknya, HAPPY BIRTHDAY!",
        "Jangan lupa traktirannya! ;)",
        "Udah ya, itu aja pesannya. Hehe."
    ];
    let currentMessageIdx = 0;
    const messageContentEl = document.getElementById('message-content');
    const nextMessageBtn = document.getElementById('nextMessageBtn');
    const skipMessageBtn = document.getElementById('skipMessageBtn');

    function displayMessage() {
        if (currentMessageIdx < messages.length) {
            messageContentEl.textContent = messages[currentMessageIdx];
        } else {
            messageContentEl.textContent = "Pesan Selesai! Terima Kasih!";
            nextMessageBtn.style.display = 'none';
            skipMessageBtn.style.display = 'none';
        }
    }

    function startMessages() {
        currentMessageIdx = 0;
        nextMessageBtn.style.display = 'block';
        skipMessageBtn.style.display = 'block';
        displayMessage();
    }

    nextMessageBtn.addEventListener('click', () => {
        playClickSound();
        currentMessageIdx++;
        displayMessage();
    });
    skipMessageBtn.addEventListener('click', () => {
        playClickSound();
        currentMessageIdx = messages.length -1; 
        displayMessage();
    });

    // --- Gallery Logic ---
    // GANTI FILE_ID_ANDA_1, FILE_ID_ANDA_2, DST DENGAN ID FILE GOOGLE DRIVE ANDA YANG SEBENARNYA
    const galleryImages = [
        { src: "https://drive.google.com/uc?export=view&id=FILE_ID_ANDA_1", caption: "Kenangan Pertama dari Drive" },
        { src: "https://drive.google.com/uc?export=view&id=FILE_ID_ANDA_2", caption: "Momen Lucu dari Drive" },
        { src: "https://drive.google.com/uc?export=view&id=FILE_ID_ANDA_3", caption: "Jalan-Jalan dari Drive" },
        { src: "https://placehold.co/150x100/8b5cf6/ffffff?text=Foto+Lokal", caption: "Foto Paling Spesial (Lokal)" } // Contoh jika ada yang bukan dari Drive
    ];
    let currentImageIdx = 0;
    const galleryImageEl = document.getElementById('galleryImage');
    const galleryCounterEl = document.getElementById('galleryCounter');
    const galleryTitleEl = document.getElementById('gallery-title'); 
    const nextImageBtn = document.getElementById('nextImageBtn');
    const printImageBtn = document.getElementById('printImageBtn');

    function displayImage() {
        if (galleryImages.length === 0) {
            galleryImageEl.src = 'https://placehold.co/150x100/25392b/9effae?text=Galeri+Kosong';
            galleryCounterEl.textContent = "Tidak ada foto di galeri.";
            return;
        }
        const imgData = galleryImages[currentImageIdx];
        galleryImageEl.src = imgData.src; 
        galleryImageEl.alt = imgData.caption;
        galleryCounterEl.textContent = `Foto ${currentImageIdx + 1} dari ${galleryImages.length}: ${imgData.caption}`;
    }

    function startGallery() {
        currentImageIdx = 0;
        displayImage();
    }
    nextImageBtn.addEventListener('click', () => {
        playClickSound();
        if (galleryImages.length > 0) {
            currentImageIdx = (currentImageIdx + 1) % galleryImages.length;
            displayImage();
        }
    });
    printImageBtn.addEventListener('click', () => {
        playClickSound();
        if (galleryImages.length > 0) {
            alert(`"Mencetak" ${galleryImages[currentImageIdx].caption}... (Simulasi)`);
        } else {
            alert("Tidak ada foto untuk dicetak.");
        }
    });


    // --- Music Player Logic ---
    const playlist = [
        { title: "Happy Birthday To You", artist: "Tradisional", src: "HBDSong", duration: 15 }, 
        { title: "On Bended Knee", artist: "Boyz II Men", src: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/music/on-bended-knee.mp3", duration: 329 },
        { title: "Nothings Gonna Change My Love", artist: "George Benson", src: "https://cdn.jsdelivr.net/gh/krsnachandra/asset@main/music/nothings-gonna-change-my-love-for-you.mp3", duration: 243 },
    ];
    let currentSongIdx = 0;
    let isPlaying = false;
    let musicInterval;

    const albumArtEl = document.getElementById('albumArt');
    const songTitleEl = document.getElementById('songTitle');
    const songArtistEl = document.getElementById('songArtist');
    const musicProgressEl = document.getElementById('musicProgress');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const nextSongBtnMusic = document.getElementById('nextSongBtn');
    const prevSongBtnMusic = document.getElementById('prevSongBtn');
    const playlistContainerEl = document.getElementById('playlistContainer');

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${min}:${sec}`;
    }

    function loadSong(songIndex) {
        clearInterval(musicInterval);
        musicProgressEl.style.width = '0%';
        const song = playlist[songIndex];
        currentSongIdx = songIndex; 
        songTitleEl.textContent = song.title;
        songArtistEl.textContent = song.artist;
        albumArtEl.src = `https://placehold.co/60x60/25392b/9effae?text=${song.artist.substring(0,3)}`; 

        if (song.src === "HBDSong") {
             if (musicPlayer.loaded && musicPlayer.state === "started") musicPlayer.stop(); 
            if (!musicSynth) {
                musicSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                }).toDestination();
            }
        } else {
            if (musicSynth && Tone.Transport.state === "started") Tone.Transport.stop(); 
            musicPlayer.load(song.src)
                .then(() => { 
                    console.log(song.title + " dimuat"); 
                    if(isPlaying) { 
                        musicPlayer.start();
                        startMusicProgressBar();
                    }
                })
                .catch(e => {
                    console.error("Ralat memuat lagu: ", song.title, e);
                });
        }
        updatePlayPauseIcon();
    }
    
    function playHBDMelody() {
        if (Tone.context.state !== 'running') {
            Tone.start();
        }
        const now = Tone.now();
        const melody = [
            { time: "0:0", note: "C4", duration: "8n" }, { time: "0:0.2", note: "C4", duration: "8n" },
            { time: "0:1", note: "D4", duration: "4n" }, { time: "0:2", note: "C4", duration: "4n" },
            { time: "0:3", note: "F4", duration: "4n" }, { time: "0:4", note: "E4", duration: "2n" },
            { time: "1:0", note: "C4", duration: "8n" }, { time: "1:0.2", note: "C4", duration: "8n" },
            { time: "1:1", note: "D4", duration: "4n" }, { time: "1:2", note: "C4", duration: "4n" },
            { time: "1:3", note: "G4", duration: "4n" }, { time: "1:4", note: "F4", duration: "2n" }
        ];
        melody.forEach(n => musicSynth.triggerAttackRelease(n.note, n.duration, now + Tone.Time(n.time).toSeconds()));
        startMusicProgressBar(); 
    }

    function startMusicProgressBar() {
        clearInterval(musicInterval);
        let progress = 0;
        if (currentSongIdx < 0 || currentSongIdx >= playlist.length) return;
        const songDuration = playlist[currentSongIdx].duration; 
        
        if (songDuration <= 0) { 
            musicProgressEl.style.width = '0%';
            return;
        }
        
        if (playlist[currentSongIdx].src === "HBDSong" || (musicPlayer.loaded && isPlaying)) {
            musicInterval = setInterval(() => {
                let currentTime = 0; 
                if (playlist[currentSongIdx].src === "HBDSong") {
                    progress += 1; 
                    currentTime = progress;
                } else if (musicPlayer.loaded && musicPlayer.state === "started") { 
                     if (musicPlayer.buffer && musicPlayer.buffer.duration) {
                         currentTime = musicPlayer.now() % musicPlayer.buffer.duration;
                     } else {
                         currentTime = progress; 
                         progress++;
                     }
                } else if (isPlaying) { 
                    progress += 1;
                    currentTime = progress;
                } else { 
                    clearInterval(musicInterval);
                    return;
                }

                let percent = (currentTime / songDuration) * 100;
                musicProgressEl.style.width = `${Math.min(percent, 100)}%`;

                if (percent >= 100) {
                    clearInterval(musicInterval);
                    if (playlist[currentSongIdx].src === "HBDSong" || isPlaying) { 
                        isPlaying = false;
                        updatePlayPauseIcon();
                         musicProgressEl.style.width = '0%'; 
                    }
                }
            }, 1000);
        }
    }

    function updatePlayPauseIcon() {
        playPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    }
    
    function togglePlayPause() {
        playClickSound();
        if (Tone.context.state !== 'running') {
            Tone.start().then(actualTogglePlay).catch(e => console.error("Ralat memulakan Tone.js:", e));
        } else {
            actualTogglePlay();
        }
    }

    function actualTogglePlay() {
        if (currentSongIdx < 0 || currentSongIdx >= playlist.length) {
            console.warn("Indeks lagu tidak valid.");
            return;
        }

        const currentSong = playlist[currentSongIdx];
        if (currentSong.src === "HBDSong") {
            if (!isPlaying) {
                playHBDMelody();
                isPlaying = true;
            } else {
                if (musicSynth && Tone.Transport.state === "started") Tone.Transport.stop(); 
                clearInterval(musicInterval); 
                isPlaying = false;
            }
        } else {
             if (musicPlayer.loaded) {
                if (isPlaying) {
                    musicPlayer.stop();
                    clearInterval(musicInterval);
                } else {
                    musicPlayer.start();
                    startMusicProgressBar();
                }
                isPlaying = !isPlaying;
            } else {
                console.warn("Lagu belum dimuat. Cuba lagi selepas beberapa ketika atau pilih lagu lain.");
                if (!musicPlayer.loaded && musicPlayer.buffer === null) { 
                    loadSong(currentSongIdx); 
                }
            }
        }
        updatePlayPauseIcon();
    }

    playPauseBtn.addEventListener('click', togglePlayPause);

    nextSongBtnMusic.addEventListener('click', () => {
        playClickSound();
        let newIndex = (currentSongIdx + 1) % playlist.length;
        isPlaying = false; 
        loadSong(newIndex);
    });
    prevSongBtnMusic.addEventListener('click', () => {
        playClickSound();
        let newIndex = (currentSongIdx - 1 + playlist.length) % playlist.length;
        isPlaying = false; 
        loadSong(newIndex);
    });

    function populatePlaylist() {
        playlistContainerEl.innerHTML = '';
        playlist.forEach((song, index) => {
            const div = document.createElement('div');
            div.textContent = `${index + 1}. ${song.title} - ${song.artist} (${formatTime(song.duration)})`;
            div.onclick = () => {
                playClickSound();
                if (isPlaying) {
                    if (playlist[currentSongIdx].src === "HBDSong") {
                        if (musicSynth && Tone.Transport.state === "started") Tone.Transport.stop();
                    } else if (musicPlayer.loaded) {
                        musicPlayer.stop();
                    }
                    clearInterval(musicInterval);
                    isPlaying = false; 
                    updatePlayPauseIcon(); 
                }
                loadSong(index);
            };
            playlistContainerEl.appendChild(div);
        });
    }

    function startMusicPlayer(){
        populatePlaylist();
        if(playlist.length > 0) {
             loadSong(currentSongIdx < playlist.length ? currentSongIdx : 0);
        } else {
            console.warn("Playlist musik kosong.");
            songTitleEl.textContent = "Playlist Kosong";
            songArtistEl.textContent = "-";
        }
    }


    // --- Tetris Logic (Simplified) ---
    const tetrisGridEl = document.getElementById('tetris-grid');
    const tetrisScoreEl = document.getElementById('tetrisScore');
    const tetrisLevelEl = document.getElementById('tetrisLevel');
    const tetrisLinesEl = document.getElementById('tetrisLines');
    const tetrisStartBtn = document.getElementById('tetrisStartBtn');
    const tetrisLeftBtn = document.getElementById('tetrisLeftBtn');
    const tetrisRightBtn = document.getElementById('tetrisRightBtn');
    const tetrisRotateBtn = document.getElementById('tetrisRotateBtn');

    const GRID_WIDTH = 10;
    const GRID_HEIGHT = 18;
    let tetrisGrid = [];
    let score = 0;
    let level = 1;
    let linesCleared = 0;
    let gameInterval;
    let currentPiece;
    let currentRow;
    let currentCol;
    let gameRunning = false;

    const TETROMINOES = {
        'I': { shape: [[1,1,1,1]], color: 'filledI' }, 
        'L': { shape: [[1,0,0], [1,1,1]], color: 'filledL' },
        'J': { shape: [[0,0,1], [1,1,1]], color: 'filledJ' },
        'T': { shape: [[0,1,0], [1,1,1]], color: 'filledT' },
        'S': { shape: [[0,1,1], [1,1,0]], color: 'filledS' },
        'Z': { shape: [[1,1,0], [0,1,1]], color: 'filledZ' },
        'O': { shape: [[1,1], [1,1]], color: 'filledO' }
    };
    const PIECE_KEYS = Object.keys(TETROMINOES);

    function createTetrisGrid() {
        tetrisGridEl.innerHTML = '';
        tetrisGrid = [];
        for (let r = 0; r < GRID_HEIGHT; r++) {
            tetrisGrid[r] = [];
            for (let c = 0; c < GRID_WIDTH; c++) {
                const cell = document.createElement('div');
                cell.classList.add('tetris-cell');
                cell.dataset.row = r;
                cell.dataset.col = c;
                tetrisGridEl.appendChild(cell);
                tetrisGrid[r][c] = { element: cell, filled: null };
            }
        }
    }
    
    function drawGrid() {
        for(let r=0; r < GRID_HEIGHT; r++) {
            for(let c=0; c < GRID_WIDTH; c++) {
                tetrisGrid[r][c].element.className = 'tetris-cell'; 
                if(tetrisGrid[r][c].filled) {
                    tetrisGrid[r][c].element.classList.add(tetrisGrid[r][c].filled);
                }
            }
        }
    }
    
    function drawPiece() {
        currentPiece.shape.forEach((row, rOffset) => {
            row.forEach((cell, cOffset) => {
                if (cell) {
                    const r = currentRow + rOffset;
                    const c = currentCol + cOffset;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH) {
                         tetrisGrid[r][c].element.classList.add(currentPiece.color);
                    }
                }
            });
        });
    }
    
    function undrawPiece() {
         currentPiece.shape.forEach((row, rOffset) => {
            row.forEach((cell, cOffset) => {
                if (cell) {
                    const r = currentRow + rOffset;
                    const c = currentCol + cOffset;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH && !tetrisGrid[r][c].filled) { 
                         tetrisGrid[r][c].element.classList.remove(currentPiece.color);
                    }
                }
            });
        });
    }

    function spawnPiece() {
        const randomKey = PIECE_KEYS[Math.floor(Math.random() * PIECE_KEYS.length)];
        currentPiece = JSON.parse(JSON.stringify(TETROMINOES[randomKey])); 
        currentRow = 0;
        currentCol = Math.floor(GRID_WIDTH / 2) - Math.floor(currentPiece.shape[0].length / 2);
        if (checkCollision(currentRow, currentCol, currentPiece.shape)) {
            gameOver();
        }
    }

    function checkCollision(row, col, pieceShape) {
        for (let r = 0; r < pieceShape.length; r++) {
            for (let c = 0; c < pieceShape[r].length; c++) {
                if (pieceShape[r][c]) {
                    const newRow = row + r;
                    const newCol = col + c;
                    if (newRow >= GRID_HEIGHT || newCol < 0 || newCol >= GRID_WIDTH || (newRow >=0 && tetrisGrid[newRow][newCol].filled) ) {
                        return true; 
                    }
                }
            }
        }
        return false;
    }
    
    function lockPiece() {
        currentPiece.shape.forEach((row, rOffset) => {
            row.forEach((cell, cOffset) => {
                if (cell) {
                    const r = currentRow + rOffset;
                    const c = currentCol + cOffset;
                    if (r >= 0 && r < GRID_HEIGHT && c >= 0 && c < GRID_WIDTH) {
                        tetrisGrid[r][c].filled = currentPiece.color;
                    }
                }
            });
        });
        clearLines();
    }

    function clearLines() {
        let linesToClear = 0;
        for (let r = GRID_HEIGHT - 1; r >= 0; r--) {
            if (tetrisGrid[r].every(cell => cell.filled)) {
                linesToClear++;
                for (let rowAbove = r; rowAbove > 0; rowAbove--) {
                    for (let c = 0; c < GRID_WIDTH; c++) {
                        tetrisGrid[rowAbove][c].filled = tetrisGrid[rowAbove - 1][c].filled;
                    }
                }
                for (let c = 0; c < GRID_WIDTH; c++) {
                    tetrisGrid[0][c].filled = null;
                }
                r++; 
            }
        }
        if (linesToClear > 0) {
            // playTonePlayerSound(tetrisLineClearSound, "Tetris line clear sound"); // Dialih keluar
            score += linesToClear * 100 * level; 
            linesCleared += linesToClear;
            if (linesCleared > 0 && linesCleared % 10 === 0) { 
                 level++;
                 clearInterval(gameInterval); 
                 gameInterval = setInterval(gameLoop, Math.max(200, 1000 - (level -1) * 50) ); 
            }
            updateTetrisUI();
        }
    }

    function moveDown() {
        if(!gameRunning) return;
        undrawPiece();
        if (!checkCollision(currentRow + 1, currentCol, currentPiece.shape)) {
            currentRow++;
        } else {
            lockPiece();
            spawnPiece();
        }
        drawGrid(); 
        drawPiece(); 
    }
    
    function moveHorizontal(direction) { 
        if(!gameRunning) return;
        // playTonePlayerSound(tetrisMoveSound, "Tetris move sound"); // Dialih keluar
        undrawPiece();
        if (!checkCollision(currentRow, currentCol + direction, currentPiece.shape)) {
            currentCol += direction;
        }
        drawPiece();
    }

    function rotatePiece() {
        if(!gameRunning) return;
        // playTonePlayerSound(tetrisMoveSound, "Tetris move sound"); // Dialih keluar
        undrawPiece();
        const originalShape = currentPiece.shape;
        const N = originalShape.length; 
        const M = originalShape[0].length;
        const newShape = Array(M).fill(null).map(() => Array(N).fill(0));

        for (let r = 0; r < N; r++) {
            for (let c = 0; c < M; c++) {
                 newShape[c][N - 1 - r] = originalShape[r][c];
            }
        }
        if (!checkCollision(currentRow, currentCol, newShape)) {
            currentPiece.shape = newShape;
        }
        drawPiece();
    }

    function updateTetrisUI() {
        tetrisScoreEl.textContent = score;
        tetrisLevelEl.textContent = level;
        tetrisLinesEl.textContent = linesCleared;
    }
    
    function gameOver() {
        clearInterval(gameInterval);
        gameRunning = false;
        tetrisStartBtn.textContent = "MULAI LAGI";
        setTimeout(() => alert(`GAME OVER! Skor: ${score}`), 100); 
    }

    function gameLoop() {
        if(gameRunning) {
            moveDown();
        }
    }

    function startTetrisGame() {
        playClickSound();
        if(gameRunning && gameInterval) { 
             clearInterval(gameInterval);
        }
        createTetrisGrid(); 
        score = 0;
        level = 1;
        linesCleared = 0;
        updateTetrisUI();
        spawnPiece();
        drawGrid(); 
        drawPiece(); 
        gameRunning = true;
        tetrisStartBtn.textContent = "BERMAIN...";
        gameInterval = setInterval(gameLoop, Math.max(200, 1000 - (level-1)*50)); 
    }
    
    function initTetris() { 
        createTetrisGrid(); 
        updateTetrisUI(); 
        if (!gameRunning) { 
            tetrisStartBtn.textContent = "MULAI GAME";
        }
    }

    tetrisStartBtn.addEventListener('click', startTetrisGame);
    tetrisLeftBtn.addEventListener('click', () => moveHorizontal(-1));
    tetrisRightBtn.addEventListener('click', () => moveHorizontal(1));
    tetrisRotateBtn.addEventListener('click', rotatePiece);

    document.getElementById('dpadUp').addEventListener('click', rotatePiece);
    document.getElementById('dpadLeft').addEventListener('click', () => moveHorizontal(-1));
    document.getElementById('dpadRight').addEventListener('click', () => moveHorizontal(1));
    document.getElementById('dpadDown').addEventListener('click', () => { 
        if(gameRunning) {
            // playTonePlayerSound(tetrisMoveSound, "Tetris move sound"); // Dialih keluar
            moveDown(); 
        }
    });
    document.getElementById('buttonA').addEventListener('click', rotatePiece); 
    document.getElementById('buttonB').addEventListener('click', () => { 
        if(currentVisibleScreen === 'tetris-screen' && gameRunning){
            // playTonePlayerSound(tetrisMoveSound, "Tetris move sound"); // Dialih keluar
            moveDown(); 
        } else {
            playClickSound(); 
        }
    });

    // Initialize
    showScreen('home-screen'); 

    function initializeAudioContext() {
        if (Tone.context.state !== 'running') {
            Tone.start().then(() => {
                console.log("Konteks Audio Tone.js berjaya dimulakan oleh interaksi pengguna.");
            }).catch(e => {
                console.warn("Gagal memulakan Tone.js AudioContext secara automatik:", e, "Menunggu interaksi pengguna seterusnya.");
            });
        }
    }
    ['click', 'touchstart', 'keydown'].forEach(eventName => {
        document.body.addEventListener(eventName, initializeAudioContext, { once: true });
    });

</script>
</body>
</html>
